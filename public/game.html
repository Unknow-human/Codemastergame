<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>CodeMaster Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(-45deg, #1e1e2f, #2f2f3f, #1a1a2a, #3f3f5f);
      background-size: 400% 400%;
      animation: gradient 10s ease infinite;
      color: #fff;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    h1, h2 {
      text-align: center;
    }

    .section {
      margin: 20px auto;
      max-width: 500px;
      background: #222;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 15px #0006;
    }

    button {
      padding: 10px 15px;
      border: none;
      background: #00c3ff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
    }

    button:hover {
      background: #0099cc;
    }

    input {
      padding: 10px;
      width: 80%;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      margin-bottom: 8px;
    }

    .flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .small {
      font-size: 0.9em;
      opacity: 0.7;
    }
  </style>
</head>
<body>

  <h1>CodeMaster Duel</h1>
  <div style="text-align: center; margin-bottom: 20px;">
  <button id="toggleTheme">Changer de thème</button>
  </div>

  <div class="section">
    <h2 id="gameStatus">Mode solo</h2>
    <div id="gameArea">
      <input id="guessInput" type="text" placeholder="Entrez un code à 4 chiffres">
      <button onclick="submitGuess()">Proposer</button>
      <button onclick="abandonGame()">Abandonner</button>
      <div id="guessHistory"></div>
    </div>
  </div>

  <div class="section">
    <h2>Joueurs en ligne</h2>
    <ul id="userList"></ul>
  </div>
<div class="section" id="chatSection">
  <h2>Chat en temps réel</h2>
  <div id="chatBox" style="height: 200px; overflow-y: auto; background: #111; padding: 10px; border-radius: 8px;"></div>
  <div class="flex" style="margin-top: 10px;">
    <input id="chatInput" type="text" placeholder="Tape ton message ici..." />
    <button onclick="sendMessage()">Envoyer</button>
  </div>
</div>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();

    const username = localStorage.getItem("username") || prompt("Ton pseudo :");
    localStorage.setItem("username", username);
    socket.emit("identify", username);

    let secretCode = generateCode();
    let roomId = "";
    let isDuel = false;
    let playing = true;

    function generateCode() {
      return Math.floor(1000 + Math.random() * 9000).toString();
    }

    function checkGuess(secret, guess) {
      let correct = 0, wellPlaced = 0;
      const s = secret.split("");
      const g = guess.split("");

      g.forEach((digit, i) => {
        if (s.includes(digit)) correct++;
        if (digit === s[i]) wellPlaced++;
      });

      return `${correct} chiffres corrects, ${wellPlaced} bien placés`;
    }

    function submitGuess() {
      const guess = document.getElementById("guessInput").value;
      if (!/^\d{4}$/.test(guess)) return alert("Code invalide.");
      document.getElementById("guessInput").value = "";

      if (isDuel) {
        socket.emit("submitGuess", { roomId, guess });
      } else {
        const result = checkGuess(secretCode, guess);
        document.getElementById("guessHistory").innerHTML += `<p>${guess} → ${result}</p>`;
        if (guess === secretCode) {
          playing = false;
          alert("Tu as gagné !");
        }
      }
    }

    function abandonGame() {
      if (!playing) return;
      if (isDuel) {
        socket.emit("abandon", { roomId });
      } else {
        alert("Tu as abandonné.");
        playing = false;
      }
    }

    function sendDuelRequest(toUser) {
      socket.emit("duelRequest", { from: username, to: toUser });
      alert(`Invitation envoyée à ${toUser}`);
    }

    function startDuel(opponent) {
      isDuel = true;
      secretCode = prompt("Entre ton code secret à 4 chiffres :");
      if (!/^\d{4}$/.test(secretCode)) return alert("Code invalide.");
      socket.emit("startDuelGame", { opponent, code: secretCode });
    }

    // SOCKET.IO EVENTS

    socket.on("userList", (list) => {
      const ul = document.getElementById("userList");
      ul.innerHTML = "";
      list.forEach(user => {
        if (user !== username) {
          const li = document.createElement("li");
          li.className = "flex";
          li.innerHTML = `<span>${user}</span> <button onclick="sendDuelRequest('${user}')">Défier</button>`;
          ul.appendChild(li);
        }
      });
    });

    socket.on("duelRequestReceived", ({ from }) => {
      if (confirm(`${from} veut te défier ! Accepter ?`)) {
        socket.emit("duelResponse", { from: username, to: from, accepted: true });
        startDuel(from);
      } else {
        socket.emit("duelResponse", { from: username, to: from, accepted: false });
      }
    });

    socket.on("duelResponseReceived", ({ from, accepted }) => {
      if (accepted) {
        alert(`${from} a accepté ! Le duel commence.`);
        startDuel(from);
      } else {
        alert(`${from} a refusé ton invitation.`);
      }
    });

    socket.on("duelStarted", (data) => {
      roomId = data.roomId;
      document.getElementById("gameStatus").innerText = "Duel en cours ! Devine le code adverse.";
      document.getElementById("gameArea").style.display = "block";
    });

    socket.on("guessResult", ({ guess, result }) => {
      document.getElementById("guessHistory").innerHTML += `<p>${guess} → ${result}</p>`;
    });

    socket.on("duelEnded", ({ winner, abandon, code }) => {
      const msg = winner === socket.id
        ? "Tu as gagné !"
        : (abandon ? "Ton adversaire a abandonné." : "Tu as perdu.");
      alert(`${msg} Le code était : ${code}`);
      document.getElementById("gameStatus").innerText = "Duel terminé.";
      playing = false;
      isDuel = false;
    });
  </script>
  <script>
  const themeBtn = document.getElementById("toggleTheme");
  const currentTheme = localStorage.getItem("theme");

  if (currentTheme === "light") {
    document.body.classList.add("light-theme");
  }

  themeBtn.addEventListener("click", () => {
    document.body.classList.toggle("light-theme");
    const isLight = document.body.classList.contains("light-theme");
    localStorage.setItem("theme", isLight ? "light" : "dark");
  });
  </script>
</body>
</html>
